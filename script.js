// Enhanced Language translations
const translations = {
    es: {
        heroTitle: "Fluidez al Alcance de tu Mano",
        heroSubtitle: "Domina inglÃ©s, espaÃ±ol, portuguÃ©s, francÃ©s o italiano conversando de forma natural con nuestro avanzado chatbot de IA",
        getAccess: "Comenzar Ahora",
        tryNow: "Probar Ahora",
        features: "CaracterÃ­sticas",
        pricing: "Precios",
        testimonials: "Testimonios",
        toggleLang: "Cambiar a InglÃ©s",
        demoTitle: "Habla con HablaYa!",
        demoSubtitle: "Prueba nuestro chatbot de IA en todos los idiomas",
        englishVersion: "VersiÃ³n en InglÃ©s",
        englishDesc: "Practica tu inglÃ©s con nuestro tutor de IA",
        tryEnglish: "Probar InglÃ©s",
        spanishVersion: "VersiÃ³n en EspaÃ±ol",
        spanishDesc: "Practica tu espaÃ±ol con nuestro tutor de IA",
        trySpanish: "Probar EspaÃ±ol",
        portugueseVersion: "VersiÃ³n en PortuguÃ©s",
        portugueseDesc: "Practica tu portuguÃ©s con nuestro tutor de IA",
        tryPortuguese: "Probar PortuguÃ©s",
        featuresSubtitle: "POR QUÃ‰ HABLAYA",
        featuresTitle: "Tu Asistente de Idiomas con IA",
        feature1Title: "IA Inteligente",
        feature1Desc: "IA adaptativa que aprende tu nivel y personaliza conversaciones",
        feature2Title: "DiÃ¡logos Reales",
        feature2Desc: "Practica conversaciones prÃ¡cticas que realmente usarÃ¡s",
        feature3Title: "Siempre Disponible",
        feature3Desc: "Practica cuando te inspire, de dÃ­a o de noche",
        feature4Title: "RetroalimentaciÃ³n InstantÃ¡nea",
        feature4Desc: "Correcciones en tiempo real de pronunciaciÃ³n y gramÃ¡tica",
        pricingSubtitle: "PLANES ACCESIBLES",
        pricingTitle: "Precios Sencillos, MÃ¡ximo Valor",
        pricingDescription: "Comienza con una prueba gratis de 7 dÃ­as, luego elige el plan que se ajuste a tus metas",
        freeTrial: "Prueba Gratis",
        freeTrialPlan: "Prueba Gratis de 7 DÃ­as",
        freeTrialSubtitle: "7 dÃ­as gratis â€¢ Sin tarjeta de crÃ©dito",
        startFreeTrial: "Comenzar Prueba Gratis",
        trialNote: "Cancela en cualquier momento durante la prueba",
        annualPlan: "Plan Anual",
        monthlyPlan: "Plan Mensual",
        perYear: "por aÃ±o",
        perMonth: "por mes",
        save10: "Ahorra 10%",
        priceFeature1: "Conversaciones ilimitadas",
        priceFeature2: "Respuestas de IA avanzada",
        priceFeature3: "Reconocimiento de Voz y Texto",
        priceFeature4: "Soporte prioritario",
        priceFeature5: "Practica donde sea, cuando quieras",
        priceFeature6: "AnalÃ­ticas avanzadas",
        buyNow: "Obtener",
        moneyBack: "GarantÃ­a de devoluciÃ³n de 30 dÃ­as",
        testimonialsSubtitle: "HISTORIAS DE Ã‰XITO",
        testimonialsTitle: "Â¡Los Estudiantes Aman HablaYa!",
        testimonial1: "Â¡PasÃ© de bÃ¡sico a conversaciones fluidas en solo 3 meses! La IA se adapta perfectamente a tu nivel.",
        testimonial2: "Finalmente una forma accesible de practicar diariamente. La retroalimentaciÃ³n sobre mi pronunciaciÃ³n cambiÃ³ todo.",
        testimonial3: "Como profesional ocupado, me encanta poder practicar durante mi commute. Â¡La IA recuerda mi progreso!",
        finalCtaTitle: "Â¿Listo para Transformar tus Habilidades LingÃ¼Ã­sticas?",
        finalCtaSubtitle: "Ãšnete a 10,000+ estudiantes que lograron fluidez con HablaYa!",
        quickLinks: "Enlaces RÃ¡pidos",
        company: "Empresa",
        aboutUs: "Nosotros",
        privacy: "Privacidad",
        terms: "TÃ©rminos",
        footerAbout: "Dominio de idiomas con IA por LearnWG",
        copyright: "Â© 2025 Learn WG. Todos los derechos reservados.",
        aboutTitle: "Sobre LearnWG",
        aboutText: "LearnWG es una compaÃ±Ã­a de tecnologÃ­a educativa que crea soluciones innovadoras para el aprendizaje de idiomas potenciadas por inteligencia artificial.",
        privacyTitle: "PolÃ­tica de Privacidad",
        privacyText: "Respetamos tu privacidad. Tus datos se cifran y usan solo para mejorar tu experiencia. Nunca vendemos o compartimos tu informaciÃ³n sin consentimiento explÃ­cito.",
        termsTitle: "TÃ©rminos de Servicio",
        termsText: "Al acceder a HablaYa!, aceptas nuestros tÃ©rminos. Las suscripciones se renuevan automÃ¡ticamente pero pueden cancelarse cuando quieras. Ofrecemos garantÃ­a de devoluciÃ³n de 30 dÃ­as si no estÃ¡s satisfecho.",
        locationMexico: "Ciudad de MÃ©xico",
        locationGuadalajara: "Guadalajara",
        locationMonterrey: "Monterrey",
        locationBrazil: "SÃ£o Paulo",
        popularChoice: "MÃ¡s Popular",
        liveChat: "Chat en Vivo",
        loginTitle: "Iniciar SesiÃ³n",
        emailLabel: "Correo ElectrÃ³nico",
        passwordLabel: "ContraseÃ±a",
        loginButton: "Iniciar SesiÃ³n",
        noAccount: "Â¿No tienes cuenta?",
        signupTitle: "Crear Cuenta",
        nameLabel: "Nombre",
        signupButton: "Registrarse",
        haveAccount: "Â¿Ya tienes cuenta?",
        dashboardTitle: "Tu Panel de Aprendizaje",
        englishSessions: "Sesiones en InglÃ©s",
        spanishSessions: "Sesiones en EspaÃ±ol",
        portugueseSessions: "Sesiones en PortuguÃ©s",
        totalSessions: "Sesiones Totales",
        currentLevel: "Nivel Actual",
        subscription: "SuscripciÃ³n",
        trialStatus: "Estado de Prueba",
        startSession: "Iniciar Nueva SesiÃ³n",
        logoutButton: "Cerrar SesiÃ³n",
        startChatbot: "Iniciar Tutor de Idiomas",
        paymentManagement: "GestiÃ³n de Pagos",
        currentPlan: "Plan Actual",
        billingHistory: "Historial de FacturaciÃ³n",
        upgradePlan: "Actualizar Plan",
        manageSubscription: "Gestionar",
        viewAllTransactions: "Ver Todas",
        trialExpired: "Prueba Expirada",
        trialActive: "Prueba Activa",
        daysLeft: "dÃ­as restantes",
        upgradeNow: "Actualizar Ahora"
    },
    en: {
        heroTitle: "Fluency at Your Fingertips",
        heroSubtitle: "Master English, Spanish, Portuguese, French, or Italian by conversing naturally with our advanced AI chatbot",
        getAccess: "Get Started",
        tryNow: "Try Now",
        features: "Features",
        pricing: "Pricing",
        testimonials: "Testimonials",
        toggleLang: "Switch to Spanish",
        demoTitle: "Speak with HablaYa!",
        demoSubtitle: "Try our AI chatbot in all languages",
        englishVersion: "English Version",
        englishDesc: "Practice your English with our AI tutor",
        tryEnglish: "Try English Version",
        spanishVersion: "Spanish Version",
        spanishDesc: "Practice your Spanish with our AI tutor",
        trySpanish: "Try Spanish Version",
        portugueseVersion: "Portuguese Version",
        portugueseDesc: "Practice your Portuguese with our AI tutor",
        tryPortuguese: "Try Portuguese Version",
        featuresSubtitle: "WHY HABLAYA",
        featuresTitle: "Your Personal AI Language Partner",
        feature1Title: "Smart AI Tutor",
        feature1Desc: "Adaptive AI that learns your level and personalizes conversations",
        feature2Title: "Real Dialogues",
        feature2Desc: "Practice practical conversations you'll actually use",
        feature3Title: "Always Available",
        feature3Desc: "Practice whenever inspiration strikes, day or night",
        feature4Title: "Instant Feedback",
        feature4Desc: "Real-time corrections on pronunciation and grammar",
        pricingSubtitle: "AFFORDABLE PLANS",
        pricingTitle: "Simple Pricing, Maximum Value",
        pricingDescription: "Start with a 7-day free trial, then choose the plan that fits your goals",
        freeTrial: "Free Trial",
        freeTrialPlan: "7-Day Free Trial",
        freeTrialSubtitle: "7 days free â€¢ No credit card required",
        startFreeTrial: "Start Free Trial",
        trialNote: "Cancel anytime during trial",
        annualPlan: "Annual Plan",
        monthlyPlan: "Monthly Plan",
        perYear: "per year",
        perMonth: "per month",
        save10: "Save 10%",
        priceFeature1: "Unlimited conversations",
        priceFeature2: "Advanced AI responses",
        priceFeature3: "Speech Recognition Technology",
        priceFeature4: "Priority support",
        priceFeature5: "Practice anytime, anywhere",
        priceFeature6: "Advanced analytics",
        buyNow: "Get",
        moneyBack: "30-day money back guarantee",
        testimonialsSubtitle: "SUCCESS STORIES",
        testimonialsTitle: "Students Love HablaYa!",
        testimonial1: "I went from basic to fluent conversations in just 3 months! The AI adapts perfectly to your level.",
        testimonial2: "Finally an affordable way to practice daily. The feedback on my pronunciation was a game-changer.",
        testimonial3: "As a busy professional, I love being able to practice during my commute. The AI remembers my progress!",
        finalCtaTitle: "Ready to Transform Your Language Skills?",
        finalCtaSubtitle: "Join 10,000+ students who achieved fluency with HablaYa!",
        quickLinks: "Quick Links",
        company: "Company",
        aboutUs: "About Us",
        privacy: "Privacy",
        terms: "Terms",
        footerAbout: "AI-powered language mastery by LearnWG",
        copyright: "Â© 2025 Learn WG. All rights reserved.",
        aboutTitle: "About LearnWG",
        aboutText: "LearnWG is an innovative edtech company creating AI-powered language learning solutions that make mastering new languages accessible, effective, and enjoyable for everyone.",
        privacyTitle: "Privacy Policy",
        privacyText: "We prioritize your privacy. Your data is encrypted and used solely to enhance your learning experience. We never sell or share your information with third parties without explicit consent.",
        termsTitle: "Terms of Service",
        termsText: "By accessing HablaYa!, you agree to our terms. Subscriptions auto-renew but can be canceled anytime. We offer a 30-day money-back guarantee if you're not satisfied.",
        locationMexico: "Mexico City",
        locationGuadalajara: "Guadalajara",
        locationMonterrey: "Monterrey",
        locationBrazil: "SÃ£o Paulo",
        popularChoice: "Most Popular",
        liveChat: "Live Conversation",
        loginTitle: "Log In",
        emailLabel: "Email",
        passwordLabel: "Password",
        loginButton: "Log In",
        noAccount: "Don't have an account?",
        signupTitle: "Create Account",
        nameLabel: "Name",
        signupButton: "Sign Up",
        haveAccount: "Already have an account?",
        dashboardTitle: "Your Learning Dashboard",
        englishSessions: "English Sessions",
        spanishSessions: "Spanish Sessions",
        portugueseSessions: "Portuguese Sessions",
        totalSessions: "Total Sessions",
        currentLevel: "Current Level",
        subscription: "Subscription",
        trialStatus: "Trial Status",
        startSession: "Start a New Session",
        logoutButton: "Log Out",
        startChatbot: "Start Language Tutor",
        paymentManagement: "Payment Management",
        currentPlan: "Current Plan",
        billingHistory: "Billing History",
        upgradePlan: "Upgrade Plan",
        manageSubscription: "Manage",
        viewAllTransactions: "View All",
        trialExpired: "Trial Expired",
        trialActive: "Trial Active",
        daysLeft: "days left",
        upgradeNow: "Upgrade Now"
    },
    pt: {
        heroTitle: "FluÃªncia na Ponta dos Dedos",
        heroSubtitle: "Domine inglÃªs, espanhol, portuguÃªs, francÃªs ou italiano conversando de forma natural com o nosso avanÃ§ado chatbot de IA",
        getAccess: "ComeÃ§ar Agora",
        tryNow: "Experimentar Agora",
        features: "Recursos",
        pricing: "PreÃ§os",
        testimonials: "Depoimentos",
        toggleLang: "Mudar para Espanhol",
        demoTitle: "Fale com HablaYa!",
        demoSubtitle: "Experimente nosso chatbot de IA em todos os idiomas",
        englishVersion: "VersÃ£o em InglÃªs",
        englishDesc: "Pratique seu inglÃªs com nosso tutor de IA",
        tryEnglish: "Experimentar InglÃªs",
        spanishVersion: "VersÃ£o em Espanhol",
        spanishDesc: "Pratique seu espanhol com nosso tutor de IA",
        trySpanish: "Experimentar Espanhol",
        portugueseVersion: "VersÃ£o em PortuguÃªs",
        portugueseDesc: "Pratique seu portuguÃªs com nosso tutor de IA",
        tryPortuguese: "Experimentar PortuguÃªs",
        featuresSubtitle: "POR QUE HABLAYA",
        featuresTitle: "Seu Parceiro de Idiomas com IA",
        feature1Title: "Tutor IA Inteligente",
        feature1Desc: "IA adaptativa que aprende seu nÃ­vel e personaliza conversas",
        feature2Title: "DiÃ¡logos Reais",
        feature2Desc: "Pratique conversas prÃ¡ticas que vocÃª realmente usarÃ¡",
        feature3Title: "Sempre DisponÃ­vel",
        feature3Desc: "Pratique quando tiver inspiraÃ§Ã£o, dia ou noite",
        feature4Title: "Feedback InstantÃ¢neo",
        feature4Desc: "CorreÃ§Ãµes em tempo real de pronÃºncia e gramÃ¡tica",
        pricingSubtitle: "PLANOS ACESSÃVEIS",
        pricingTitle: "PreÃ§os Simples, MÃ¡ximo Valor",
        pricingDescription: "Comece com um teste grÃ¡tis de 7 dias, depois escolha o plano que atende aos seus objetivos",
        freeTrial: "Teste GrÃ¡tis",
        freeTrialPlan: "Teste GrÃ¡tis de 7 Dias",
        freeTrialSubtitle: "7 dias grÃ¡tis â€¢ Nenhum cartÃ£o de crÃ©dito necessÃ¡rio",
        startFreeTrial: "ComeÃ§ar Teste GrÃ¡tis",
        trialNote: "Cancele a qualquer momento durante o teste",
        annualPlan: "Plano Anual",
        monthlyPlan: "Plano Mensal",
        perYear: "por ano",
        perMonth: "por mÃªs",
        save10: "Economize 10%",
        priceFeature1: "Conversas ilimitadas",
        priceFeature2: "Respostas de IA avanÃ§ada",
        priceFeature3: "Tecnologia de Reconhecimento de Voz",
        priceFeature4: "Suporte prioritÃ¡rio",
        priceFeature5: "Pratique a qualquer hora, em qualquer lugar",
        priceFeature6: "Analytics avanÃ§ados",
        buyNow: "Obter",
        moneyBack: "Garantia de devoluÃ§Ã£o em 30 dias",
        testimonialsSubtitle: "HISTÃ“RIAS DE SUCESSO",
        testimonialsTitle: "Os Alunos Amam o HablaYa!",
        testimonial1: "Fui de conversas bÃ¡sicas para fluentes em apenas 3 meses! A IA se adapta perfeitamente ao seu nÃ­vel.",
        testimonial2: "Finalmente uma maneira acessÃ­vel de praticar diariamente. O feedback sobre minha pronÃºncia mudou tudo.",
        testimonial3: "Como profissional ocupado, adoro poder praticar durante meu deslocamento. A IA lembra do meu progresso!",
        finalCtaTitle: "Pronto para Transformar suas Habilidades LinguÃ­sticas?",
        finalCtaSubtitle: "Junte-se a mais de 10.000 alunos que alcanÃ§aram fluÃªncia com HablaYa!",
        quickLinks: "Links RÃ¡pidos",
        company: "Empresa",
        aboutUs: "Sobre NÃ³s",
        privacy: "Privacidade",
        terms: "Termos",
        footerAbout: "DomÃ­nio de idiomas com IA por LearnWG",
        copyright: "Â© 2025 Learn WG. Todos os direitos reservados.",
        aboutTitle: "Sobre LearnWG",
        aboutText: "LearnWG Ã© uma empresa de tecnologia educacional inovadora que cria soluÃ§Ãµes de aprendizado de idiomas com IA que tornam o domÃ­nio de novos idiomas acessÃ­vel, eficaz e agradÃ¡vel para todos.",
        privacyTitle: "PolÃ­tica de Privacidade",
        privacyText: "Priorizamos sua privacidade. Seus dados sÃ£o criptografados e usados apenas para melhorar sua experiÃªncia de aprendizado. Nunca vendemos ou compartilhamos suas informaÃ§Ãµes com terceiros sem consentimento explÃ­cito.",
        termsTitle: "Termos de ServiÃ§o",
        termsText: "Ao acessar o HablaYa!, vocÃª concorda com nossos termos. As assinaturas sÃ£o renovadas automaticamente, mas podem ser canceladas a qualquer momento. Oferecemos uma garantia de devoluÃ§Ã£o do dinheiro em 30 dias se vocÃª nÃ£o estiver satisfeito.",
        locationMexico: "Cidade do MÃ©xico",
        locationGuadalajara: "Guadalajara",
        locationMonterrey: "Monterrey",
        locationBrazil: "SÃ£o Paulo",
        popularChoice: "Mais Popular",
        liveChat: "Conversa ao Vivo",
        loginTitle: "Entrar",
        emailLabel: "Email",
        passwordLabel: "Senha",
        loginButton: "Entrar",
        noAccount: "NÃ£o tem uma conta?",
        signupTitle: "Criar Conta",
        nameLabel: "Nome",
        signupButton: "Registrar",
        haveAccount: "JÃ¡ tem uma conta?",
        dashboardTitle: "Seu Painel de Aprendizado",
        englishSessions: "SessÃµes em InglÃªs",
        spanishSessions: "SessÃµes em Espanhol",
        portugueseSessions: "SessÃµes em PortuguÃªs",
        totalSessions: "SessÃµes Totais",
        currentLevel: "NÃ­vel Atual",
        subscription: "Assinatura",
        trialStatus: "Status do Teste",
        startSession: "Iniciar Nova SessÃ£o",
        logoutButton: "Sair",
        startChatbot: "Iniciar Tutor de Idiomas",
        paymentManagement: "GestÃ£o de Pagamentos",
        currentPlan: "Plano Atual",
        billingHistory: "HistÃ³rico de Faturamento",
        upgradePlan: "Atualizar Plano",
        manageSubscription: "Gerenciar",
        viewAllTransactions: "Ver Todas",
        trialExpired: "Teste Expirado",
        trialActive: "Teste Ativo",
        daysLeft: "dias restantes",
        upgradeNow: "Atualizar Agora"
    }
};

// Firebase configuration - REPLACE WITH YOUR ACTUAL CONFIG
const firebaseConfig = {
    apiKey: "AIzaSyDCgyLbGewcv6zfz7eCSNBKmhPF3fKurew",
    authDomain: "hablaya-79760.firebaseapp.com",
    projectId: "hablaya-79760",
    storageBucket: "hablaya-79760.appspot.com",
    messagingSenderId: "933344055830",
    appId: "1:933344055830:web:d39edec28fc6395e259b37"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    // Set initial language
    const currentLang = document.documentElement.getAttribute('data-lang') || 'es';
    updateLanguage(currentLang);
    
    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', toggleTheme);
    
    // Language toggle
    const langToggle = document.getElementById('lang-toggle');
    const mobileLangToggle = document.getElementById('mobile-lang-toggle');
    langToggle.addEventListener('click', toggleLanguage);
    mobileLangToggle.addEventListener('click', toggleLanguage);
    
    // Mobile menu
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const closeMenuBtn = document.getElementById('close-menu');
    const mobileMenu = document.getElementById('mobile-menu');
    
    mobileMenuBtn.addEventListener('click', function() {
        mobileMenu.classList.add('active');
        mobileMenuBtn.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
    });
    
    closeMenuBtn.addEventListener('click', function() {
        mobileMenu.classList.remove('active');
        mobileMenuBtn.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
    });
    
    // Modal functionality
    const modalTriggers = document.querySelectorAll('.modal-trigger');
    const closeButtons = document.querySelectorAll('.close-modal');
    
    modalTriggers.forEach(trigger => {
        trigger.addEventListener('click', function(e) {
            e.preventDefault();
            const modalId = this.getAttribute('data-modal');
            document.getElementById(modalId).style.display = 'flex';
            document.body.style.overflow = 'hidden';
        });
    });
    
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
            document.body.style.overflow = '';
        });
    });
    
    window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
            document.body.style.overflow = '';
        }
    });
    
    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            if (this.classList.contains('modal-trigger')) return;
            
            e.preventDefault();
            
            const targetId = this.getAttribute('href');
            if (targetId === '#') return;
            
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth'
                });
                
                // Close mobile menu if open
                mobileMenu.classList.remove('active');
                mobileMenuBtn.setAttribute('aria-expanded', 'false');
                document.body.style.overflow = '';
            }
        });
    });
    
    // Auth button event listeners
    const authBtn = document.getElementById('auth-btn');
    const mobileAuthBtn = document.getElementById('mobile-auth-btn');
    const tryFreeBtn = document.getElementById('try-free-btn');
    const tryChatbotBtns = document.querySelectorAll('.try-chatbot');
    
    authBtn.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('login-modal').style.display = 'flex';
    });
    
    mobileAuthBtn.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('login-modal').style.display = 'flex';
        mobileMenu.classList.remove('active');
    });
    
    tryFreeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('login-modal').style.display = 'flex';
    });
    
    tryChatbotBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            if (auth.currentUser) {
                startNewSession('all');
            } else {
                document.getElementById('login-modal').style.display = 'flex';
            }
        });
    });
    
    // Switch between login and signup forms
    document.querySelectorAll('.switch-auth').forEach(button => {
        button.addEventListener('click', function() {
            const targetModal = this.dataset.target;
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            document.getElementById(targetModal).style.display = 'flex';
        });
    });
    
    // Login form submission
    const loginForm = document.getElementById('login-form');
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        auth.signInWithEmailAndPassword(email, password)
            .then(() => {
                document.getElementById('login-modal').style.display = 'none';
                // Success - modal will close via auth state change handler
            })
            .catch(error => {
                document.getElementById('login-error').textContent = error.message;
            });
    });
    
    // Signup form submission
    const signupForm = document.getElementById('signup-form');
    signupForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Create user document in Firestore with trial data
                const trialEnd = new Date();
                trialEnd.setDate(trialEnd.getDate() + 7); // 7-day trial
                
                return db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    englishSessions: 0,
                    spanishSessions: 0,
                    portugueseSessions: 0,
                    trialActive: true,
                    trialEnd: firebase.firestore.Timestamp.fromDate(trialEnd),
                    trialUsed: false,
                    subscription: 'trial',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
            })
            .then(() => {
                document.getElementById('signup-form').style.display = 'none';
                // Success - modal will close via auth state change handler
            })
            .catch(error => {
                document.getElementById('signup-error').textContent = error.message;
            });
    });
    
    // Logout button
    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn.addEventListener('click', function() {
        auth.signOut();
    });
    
    // Dashboard button
    const startChatbotBtn = document.getElementById('start-chatbot');
    startChatbotBtn.addEventListener('click', function() {
        startNewSession('all');
    });
    
    // Trial button event listener
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('trial-btn')) {
            e.preventDefault();
            if (auth.currentUser) {
                activateTrial();
            } else {
                document.getElementById('signup-modal').style.display = 'flex';
            }
        }
        
        // Upgrade plan button
        if (e.target.classList.contains('upgrade-btn')) {
            e.preventDefault();
            showUpgradeOptions();
        }
        
        // Manage subscription button
        if (e.target.classList.contains('manage-btn')) {
            e.preventDefault();
            showSubscriptionManagement();
        }
    });
    
    // Auth state observer
    auth.onAuthStateChanged(user => {
        if (user) {
            // User is signed in
            showDashboard(user);
            updateUserLastLogin(user.uid);
            setPayPalUserId(user);
        } else {
            // User is signed out
            hideDashboard();
        }
    });
    
    // Update flag based on language
    updateLanguageFlags();
});

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    
    const themeIcon = document.querySelector('.theme-icon');
    themeIcon.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
    
    localStorage.setItem('hablaya-theme', newTheme);
}

function toggleLanguage() {
    const currentLang = document.documentElement.getAttribute('data-lang');
    let newLang;
    if (currentLang === 'es') newLang = 'en';
    else if (currentLang === 'en') newLang = 'pt';
    else newLang = 'es';
    
    document.documentElement.setAttribute('data-lang', newLang);
    updateLanguage(newLang);
    updateLanguageFlags();
    
    localStorage.setItem('hablaya-lang', newLang);
}

function updateLanguage(lang) {
    document.querySelectorAll('[data-i18n]').forEach(element => {
        translateElement(element, lang);
    });
}

function translateElement(element, lang) {
    const key = element.getAttribute('data-i18n');
    if (translations[lang] && translations[lang][key]) {
        if (element.tagName === 'INPUT' && element.type === 'submit') {
            element.value = translations[lang][key];
        } else {
            element.textContent = translations[lang][key];
        }
    }
}

function updateLanguageFlags() {
    const currentLang = document.documentElement.getAttribute('data-lang');
    const flags = document.querySelectorAll('.lang-flag');
    const langTexts = document.querySelectorAll('.lang-text');
    
    if (currentLang === 'es') {
        flags.forEach(flag => flag.textContent = 'ðŸ‡²ðŸ‡½');
        langTexts.forEach(text => {
            if (text.classList.contains('lang-text')) {
                text.textContent = 'ES';
            }
        });
    } else if (currentLang === 'en') {
        flags.forEach(flag => flag.textContent = 'ðŸ‡ºðŸ‡¸');
        langTexts.forEach(text => {
            if (text.classList.contains('lang-text')) {
                text.textContent = 'EN';
            }
        });
    } else {
        flags.forEach(flag => flag.textContent = 'ðŸ‡§ðŸ‡·');
        langTexts.forEach(text => {
            if (text.classList.contains('lang-text')) {
                text.textContent = 'PT';
            }
        });
    }
}

function showDashboard(user) {
    // Hide main app and show dashboard
    document.getElementById('app-container').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    
    // Immediately show basic user info from auth
    document.getElementById('user-name').textContent = user.displayName || 'User';
    document.getElementById('user-email').textContent = user.email || '';
    
    // Then get additional user data from Firestore
    db.collection('users').doc(user.uid).get()
        .then(doc => {
            if (doc.exists) {
                const userData = doc.data();
                
                // Update user info (prefer Firestore name if available)
                if (userData.name) {
                    document.getElementById('user-name').textContent = userData.name;
                }
                
                // Update session counts
                document.getElementById('total-count').textContent = 
                    (userData.englishSessions || 0) + (userData.spanishSessions || 0) + (userData.portugueseSessions || 0);
                
                // Update subscription type
                const subscriptionType = document.getElementById('subscription-type');
                if (userData.subscription === 'trial') {
                    subscriptionType.textContent = 'Free Trial';
                } else if (userData.subscription === 'premium') {
                    subscriptionType.textContent = 'Premium';
                } else {
                    subscriptionType.textContent = 'Free';
                }
                
                // Update trial status
                updateTrialUI(userData);
                
                // Load session history
                loadSessionHistory(user.uid);
                
                // Load billing history
                loadBillingHistory(user.uid);
            } else {
                // Create user document if it doesn't exist (for OAuth users)
                const trialEnd = new Date();
                trialEnd.setDate(trialEnd.getDate() + 7);
                
                return db.collection('users').doc(user.uid).set({
                    name: user.displayName || 'New User',
                    email: user.email || '',
                    englishSessions: 0,
                    spanishSessions: 0,
                    portugueseSessions: 0,
                    trialActive: true,
                    trialEnd: firebase.firestore.Timestamp.fromDate(trialEnd),
                    trialUsed: false,
                    subscription: 'trial',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        })
        .catch(error => {
            console.error("Error getting user document:", error);
        });
}

function hideDashboard() {
    // Show main app and hide dashboard
    document.getElementById('app-container').style.display = 'block';
    document.getElementById('dashboard').style.display = 'none';
    
    // Close all modals
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
}

function startNewSession(language) {
    const user = auth.currentUser;
    if (!user) {
        document.getElementById('login-modal').style.display = 'flex';
        return;
    }
    
    // Show loading state
    const sessionBtn = document.getElementById('start-chatbot');
    const originalText = sessionBtn.innerHTML;
    sessionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
    sessionBtn.disabled = true;
    
    // Record the session start
    const sessionData = {
        language: 'all',
        startTime: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'active'
    };
    
    db.collection('users').doc(user.uid).collection('sessions').add(sessionData)
        .then(docRef => {
            // Open the chatbot in a new tab
            const url = 'https://hablayalanguagetutor.vercel.app/';
            const newWindow = window.open(url, '_blank');
            
            // Check if the window was successfully opened
            if (newWindow) {
                // Listen for window closing to record session end
                const checkWindowClosed = setInterval(() => {
                    if (newWindow.closed) {
                        clearInterval(checkWindowClosed);
                        endSession(user.uid, docRef.id);
                    }
                }, 1000);
            } else {
                // If popup was blocked, end the session immediately
                endSession(user.uid, docRef.id);
                alert('Please allow popups to track your session duration.');
            }
        })
        .catch(error => {
            console.error('Error starting session:', error);
            alert('Error starting session. Please try again.');
        })
        .finally(() => {
            // Restore button state
            sessionBtn.innerHTML = originalText;
            sessionBtn.disabled = false;
        });
}

function endSession(userId, sessionId) {
    db.collection('users').doc(userId).collection('sessions').doc(sessionId).update({
        endTime: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'completed'
    })
    .then(() => {
        // Update session counts
        updateSessionCounts(userId);
        // Refresh session history
        loadSessionHistory(userId);
    })
    .catch(error => {
        console.error('Error ending session:', error);
    });
}

function updateSessionCounts(userId) {
    // Increment the appropriate session counter
    const userRef = db.collection('users').doc(userId);
    
    // For simplicity, we'll increment the counter without checking which language
    // In a real app, you'd want to track which language was used
    userRef.update({
        englishSessions: firebase.firestore.FieldValue.increment(1),
        lastSession: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
        // Update the UI
        const englishCount = document.getElementById('english-count');
        englishCount.textContent = parseInt(englishCount.textContent) + 1;
        
        const totalCount = document.getElementById('total-count');
        totalCount.textContent = parseInt(totalCount.textContent) + 1;
    });
}

function loadSessionHistory(userId) {
    const sessionList = document.getElementById('session-list');
    sessionList.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
    
    db.collection('users').doc(userId).collection('sessions')
        .orderBy('startTime', 'desc')
        .limit(10)
        .get()
        .then(querySnapshot => {
            sessionList.innerHTML = '';
            
            if (querySnapshot.empty) {
                sessionList.innerHTML = '<div class="empty-sessions">No sessions yet. Start your first session!</div>';
                return;
            }
            
            querySnapshot.forEach(doc => {
                const sessionData = doc.data();
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item';
                
                // Calculate duration if session is completed
                let durationText = 'In progress';
                if (sessionData.endTime && sessionData.startTime) {
                    const duration = (sessionData.endTime.toDate() - sessionData.startTime.toDate()) / 1000 / 60; // in minutes
                    durationText = `${Math.round(duration)} min`;
                }
                
                // Format date
                const sessionDate = sessionData.startTime ? 
                    sessionData.startTime.toDate().toLocaleString() : 'Just now';
                
                // Determine language display text
                let languageText = 'Language Practice';
                
                sessionItem.innerHTML = `
                    <div class="session-info">
                        <span class="session-language">${languageText}</span>
                        <span class="session-date">${sessionDate}</span>
                    </div>
                    <div class="session-duration">${durationText}</div>
                `;
                
                sessionList.appendChild(sessionItem);
            });
        })
        .catch(error => {
            console.error('Error loading session history:', error);
            sessionList.innerHTML = '<div class="empty-sessions">Error loading sessions. Please try again.</div>';
        });
}

function updateUserLastLogin(userId) {
    db.collection('users').doc(userId).update({
        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
    });
}

// Check for saved theme preference
const savedTheme = localStorage.getItem('hablaya-theme');
if (savedTheme) {
    document.documentElement.setAttribute('data-theme', savedTheme);
    const themeIcon = document.querySelector('.theme-icon');
    themeIcon.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
}

// Check for saved language preference
const savedLang = localStorage.getItem('hablaya-lang');
if (savedLang) {
    document.documentElement.setAttribute('data-lang', savedLang);
    updateLanguage(savedLang);
    updateLanguageFlags();
}

// Trial system functions
function activateTrial() {
    const user = auth.currentUser;
    if (!user) return;
    
    const trialEnd = new Date();
    trialEnd.setDate(trialEnd.getDate() + 7);
    
    db.collection('users').doc(user.uid).update({
        trialActive: true,
        trialEnd: firebase.firestore.Timestamp.fromDate(trialEnd),
        trialUsed: true,
        subscription: 'trial'
    })
    .then(() => {
        alert('Your 7-day free trial has been activated!');
        showDashboard(user); // Refresh dashboard
    })
    .catch(error => {
        console.error('Error activating trial:', error);
        alert('Error activating trial. Please try again.');
    });
}

function checkTrialStatus(userData) {
    if (!userData.trialActive || !userData.trialEnd) return 'no-trial';
    
    const now = new Date();
    const trialEnd = userData.trialEnd.toDate();
    
    if (now > trialEnd) {
        return 'expired';
    } else {
        const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
        return { status: 'active', daysLeft };
    }
}

function showUpgradeOptions() {
    // Scroll to pricing section
    document.getElementById('pricing').scrollIntoView({ behavior: 'smooth' });
}

function showSubscriptionManagement() {
    // Show subscription management modal or redirect to payment portal
    alert('Subscription management features coming soon!');
}

function updateTrialUI(userData) {
    const trialStatus = document.getElementById('trial-status');
    const planBadge = document.getElementById('plan-badge');
    const planDetails = document.getElementById('plan-details');
    const trialExpiry = document.getElementById('trial-expiry');
    const upgradeBtn = document.querySelector('.upgrade-btn');
    
    const trialInfo = checkTrialStatus(userData);
    
    if (trialInfo === 'no-trial') {
        trialStatus.textContent = 'No Trial';
        planBadge.textContent = 'Free';
        planBadge.className = 'plan-badge';
        planDetails.textContent = 'No active trial';
        trialExpiry.textContent = 'N/A';
        upgradeBtn.textContent = 'Start Trial';
    } else if (trialInfo === 'expired') {
        trialStatus.textContent = 'Expired';
        planBadge.textContent = 'Trial Expired';
        planBadge.className = 'plan-badge trial';
        planDetails.textContent = 'Your trial has expired';
        trialExpiry.textContent = 'Expired';
        upgradeBtn.textContent = 'Upgrade Now';
    } else {
        trialStatus.textContent = `${trialInfo.daysLeft} days left`;
        planBadge.textContent = 'Free Trial';
        planBadge.className = 'plan-badge trial';
        planDetails.textContent = '7-day free trial active';
        
        const expiryDate = userData.trialEnd.toDate().toLocaleDateString();
        trialExpiry.textContent = expiryDate;
        upgradeBtn.textContent = 'Upgrade Now';
    }
}

function loadBillingHistory(userId) {
    const billingList = document.getElementById('billing-list');
    
    db.collection('users').doc(userId).collection('transactions')
        .orderBy('date', 'desc')
        .limit(5)
        .get()
        .then(querySnapshot => {
            billingList.innerHTML = '';
            
            if (querySnapshot.empty) {
                billingList.innerHTML = `
                    <div class="billing-item">
                        <span class="billing-date">No transactions yet</span>
                        <span class="billing-amount">-</span>
                    </div>
                `;
                return;
            }
            
            querySnapshot.forEach(doc => {
                const transaction = doc.data();
                const billingItem = document.createElement('div');
                billingItem.className = 'billing-item';
                
                const date = transaction.date ? transaction.date.toDate().toLocaleDateString() : 'Unknown';
                const amount = transaction.amount ? `$${transaction.amount} MXN` : '-';
                
                billingItem.innerHTML = `
                    <span class="billing-date">${transaction.description || 'Subscription'}</span>
                    <span class="billing-amount">${amount}</span>
                `;
                
                billingList.appendChild(billingItem);
            });
        })
        .catch(error => {
            console.error('Error loading billing history:', error);
            billingList.innerHTML = `
                <div class="billing-item">
                    <span class="billing-date">Error loading transactions</span>
                    <span class="billing-amount">-</span>
                </div>
            `;
        });
}

function setPayPalUserId(user) {
    document.querySelectorAll('#paypal-custom-userid').forEach(input => {
        input.value = user.uid;
    });
}
